<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì¶”ì–µì˜ ìƒì</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * { box-sizing: border-box; font-family: system-ui, sans-serif; }
    body { background:#f5f7fb; margin:0; padding:20px; }
    .container { max-width: 900px; margin:auto; }

    h1 { text-align:center; margin-bottom: 10px; }
    h2, h3 { margin-top: 0; }

    .btn {
      padding:10px 18px; border:none; border-radius:30px; cursor:pointer;
      font-weight:600; font-size:14px; color:white; background:#4b6bff;
      margin:4px; box-shadow:0 3px 8px rgba(75,107,255,0.35);
    }
    .btn.secondary { background:#e2e6ff; color:#1c266b; box-shadow:none; }
    .btn.danger { background:#ff4b6b; }

    .card {
      background:white; padding:20px; border-radius:14px;
      margin-bottom:20px; box-shadow:0 5px 16px rgba(0,0,0,0.08);
    }

    .hidden { display:none; }

    input, select {
      padding:7px 10px; border:1px solid #cfd4df; border-radius:8px; width:100%;
      font-size:14px;
    }

    .question-box { margin-bottom:14px; }
    .question-box label { font-weight:600; display:block; margin-bottom:6px; }

    .rank-label { font-size:13px; margin-top:4px; margin-bottom:2px; display:block; }

    #resultBox {
      white-space:pre-wrap;
      background:#0f172a;
      color:#e5e7eb;
      padding:12px;
      border-radius:10px;
      font-size:13px;
      max-height:400px;
      overflow-y:auto;
    }
  </style>
</head>

<body>
<div class="container">
  <h1>ì¶”ì–µì˜ ìƒì</h1>

  <!-- ëª¨ë“œ ì„ íƒ -->
  <div id="modeSelect" class="card" style="text-align:center;">
    <p>ëª¨ë“œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
    <button class="btn" onclick="showParticipant()">ì°¸ì—¬ì ëª¨ë“œ</button>
    <button class="btn secondary" onclick="showAdminLogin()">ê´€ë¦¬ì ëª¨ë“œ</button>
  </div>

  <!-- ê´€ë¦¬ì ë¡œê·¸ì¸ -->
  <div id="adminLogin" class="card hidden">
    <h3>ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ì…ë ¥</h3>
    <input type="password" id="adminPW" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
    <button class="btn" onclick="checkAdmin()">í™•ì¸</button>
    <button class="btn secondary" onclick="backToMode()">ë’¤ë¡œê°€ê¸°</button>
  </div>

  <!-- ì°¸ì—¬ì í™”ë©´ -->
  <div id="participant" class="card hidden">
    <h2>ì¹œêµ¬ë“¤ì„ ë– ì˜¬ë¦¬ë©° ì„ íƒí•´ì£¼ì„¸ìš” (TOP2)</h2>
    <p style="font-size:13px; color:#4b5563;">
      1ìœ„ëŠ” 2ì , 2ìœ„ëŠ” 1ì ìœ¼ë¡œ ë°˜ì˜ë©ë‹ˆë‹¤.<br>
      ì´ë¦„ì€ ê°€ëŠ¥í•œ í•œ ë™ì¼í•œ ë°©ì‹ìœ¼ë¡œ ì ì–´ ì£¼ì„¸ìš”. (ì˜ˆ: ì´ì§€í›ˆ / ì§€í›ˆ)
    </p>

    <div id="questions"></div>

    <button class="btn" onclick="submitVotes()">ì œì¶œí•˜ê¸°</button>
    <button class="btn secondary" onclick="backToMode()">ì²˜ìŒìœ¼ë¡œ</button>
  </div>

  <!-- ê´€ë¦¬ì íŒ¨ë„ -->
  <div id="adminPanel" class="card hidden">
    <h2>ê´€ë¦¬ì íŒ¨ë„</h2>
    <p style="font-size:14px;">
      <b>ì´ ì œì¶œ ì¸ì›:</b> <span id="totalVotes">0</span> ëª…
    </p>
    <div style="margin-bottom:10px;">
      <button class="btn secondary" onclick="refreshData()">ìƒˆë¡œê³ ì¹¨</button>
      <button class="btn danger" onclick="resetAll()">ë°ì´í„° ì´ˆê¸°í™”</button>
      <button class="btn secondary" onclick="backToMode()">ì²˜ìŒìœ¼ë¡œ</button>
    </div>

    <div class="card" style="margin:-10px -20px 10px -20px; box-shadow:none;">
      <h3>ì§ˆë¬¸ë³„ ê²°ê³¼ ë³´ê¸°</h3>
      <select id="graphSelect" style="margin-bottom:8px;"></select>
      <button class="btn secondary" onclick="showQuestionResult()">ì„ íƒí•œ ì§ˆë¬¸ ê²°ê³¼ ë³´ê¸°</button>
    </div>

    <div class="card" style="margin:-10px -20px 10px -20px; box-shadow:none;">
      <h3>ì „ì²´ í•©ì‚° ê²°ê³¼</h3>
      <button class="btn secondary" onclick="showTotal()">ì „ì²´ í•©ì‚° ì ìˆ˜ ë³´ê¸°</button>
    </div>

    <h3>ê²°ê³¼ ì¶œë ¥</h3>
    <div id="resultBox">ê²°ê³¼ê°€ ì—¬ê¸° í‘œì‹œë©ë‹ˆë‹¤.</div>
  </div>
</div>

<!-- ğŸ”¹ Firebase SDK (v8 ê¸€ë¡œë²Œ ë²„ì „ ì‚¬ìš©) -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
  // ğŸ”¹ ë„¤ê°€ ë§Œë“  Firebase í”„ë¡œì íŠ¸ ì„¤ì •
  const firebaseConfig = {
    apiKey: "AIzaSyDXgMap5ujky9QFQBq454Y0EKQ1hExwC84",
    authDomain: "lets-go-5eead.firebaseapp.com",
    databaseURL: "https://lets-go-5eead-default-rtdb.firebaseio.com",
    projectId: "lets-go-5eead",
    storageBucket: "lets-go-5eead.firebasestorage.app",
    messagingSenderId: "322694631942",
    appId: "1:322694631942:web:c5382b618de2ed15f8e987",
    measurementId: "G-6PCTNZMML1"
  };

  // Firebase ì´ˆê¸°í™”
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
</script>

<script>
  // ===========================
  //  ì„¤ì • & ìƒìˆ˜
  // ===========================
  const QUESTIONS = [
    "ì²­ì†Œë¥¼ ì—´ì‹¬íˆ í•˜ë˜ ì¹œêµ¬",
    "ë„ì›€ì´ í•„ìš”í•  ë•Œ ê¸°ëŒˆ ìˆ˜ ìˆì—ˆë˜ ì¹œêµ¬",
    "í•™êµ í–‰ì‚¬, ì¼ì • ë“± ì „ë‹¬ ì‚¬í•­ì„ ì˜ ê³µì§€í•´ì£¼ë˜ ì¹œêµ¬",
    "ìˆ˜ì—… ë¶„ìœ„ê¸° ì¡°ì„±ì„ ì˜ ë§ì¶°ì£¼ë˜ ì¹œêµ¬",
    "í˜ë“¤ ë•Œ ì›ƒì„ ìˆ˜ ìˆê²Œ í•´ì£¼ë˜ ì¹œêµ¬",
    "í•™êµ í–‰ì‚¬ì— ì—´ì‹¬íˆ ì°¸ì—¬í•˜ë˜ ì¹œêµ¬",
    "ë¦¬ë”ì‹­, ì¹´ë¦¬ìŠ¤ë§ˆê°€ ë„˜ì¹˜ë˜ ì¹œêµ¬",
    "ë´‰ì‚¬í™œë™ì„ ì—´ì‹¬íˆ í•˜ë˜ ì¹œêµ¬",
    "ì‚¬ì†Œí•œ ì¼ì—ë„ ì•½ì†ì„ ì˜ ì§€í‚¤ë˜ ì¹œêµ¬",
    "ë°”ë¥¸ì–¸ì–´, ë°”ë¥¸ í–‰ë™ ë“± í’ˆì„±ì´ ì•„ë¦„ë‹µë˜ ì¹œêµ¬"
  ];

  const PASSWORD = "YCHS1315";

  // ê° ë¸Œë¼ìš°ì €ì— ê³ ìœ  IDë¥¼ í•˜ë‚˜ì”© ë¶€ì—¬í•´ì„œ
  // ê°™ì€ ê¸°ê¸°ì—ì„œ ì—¬ëŸ¬ ë²ˆ ì œì¶œ ëª» í•˜ê²Œ ë§‰ê¸°
  const KEY_CLIENT = "memoryBox_clientId_v1";
  const KEY_SUBMITTED = "memoryBox_submitted_v2";

  let cachedSubmissions = {}; // Firebaseì—ì„œ ì½ì–´ì˜¨ ì „ì²´ ì œì¶œ ë°ì´í„° ìºì‹œ

  // ===========================
  //  ê³µí†µ UI ì œì–´
  // ===========================
  function hideAll() {
    document.getElementById("modeSelect").classList.add("hidden");
    document.getElementById("adminLogin").classList.add("hidden");
    document.getElementById("participant").classList.add("hidden");
    document.getElementById("adminPanel").classList.add("hidden");
  }

  function backToMode() {
    hideAll();
    document.getElementById("modeSelect").classList.remove("hidden");
  }

  // í´ë¼ì´ì–¸íŠ¸ ê³ ìœ  ID ìƒì„±/íšë“
  function getClientId() {
    let id = localStorage.getItem(KEY_CLIENT);
    if (!id) {
      id = "client_" + Date.now() + "_" + Math.random().toString(36).substr(2, 9);
      localStorage.setItem(KEY_CLIENT, id);
    }
    return id;
  }

  // ===========================
  //  ì°¸ì—¬ì ëª¨ë“œ
  // ===========================
  function showParticipant() {
    if (localStorage.getItem(KEY_SUBMITTED) === "yes") {
      alert("ì´ë¯¸ ì´ ê¸°ê¸°ì—ì„œ íˆ¬í‘œë¥¼ ì œì¶œí–ˆìŠµë‹ˆë‹¤!");
      return;
    }
    hideAll();
    document.getElementById("participant").classList.remove("hidden");
    buildQuestionForm();
  }

  function buildQuestionForm() {
    const box = document.getElementById("questions");
    box.innerHTML = "";

    QUESTIONS.forEach((q, i) => {
      box.innerHTML += `
        <div class="question-box">
          <label>${i + 1}. ${q}</label>
          <span class="rank-label">1ìœ„ (2ì )</span>
          <input id="q${i}_1" placeholder="ì˜ˆ: ì´ì§€í›ˆ / ì§€í›ˆ">
          <span class="rank-label">2ìœ„ (1ì )</span>
          <input id="q${i}_2" placeholder="ì˜ˆ: ì´ì§€í›ˆ / ì§€í›ˆ">
        </div>
      `;
    });
  }

  // ì´ë¦„ ì •ê·œí™”: ê³µë°± ì œê±° + í˜¸ì¹­ ì œê±° + ë ë‘ ê¸€ì(ì´ë¦„ ë¶€ë¶„)ë§Œ ì‚¬ìš©
  function normalizeName(name) {
    if (!name) return "";
    name = name.trim();
    name = name.replace(/\s+/g, "");               // ê³µë°± ì œê±°
    name = name.replace(/(ì´|ì•¼|ë‹˜|êµ°|ì–‘|ì”¨|ìš”)$/g, ""); // ë§ë í˜¸ì¹­ ì œê±°
    if (name.length >= 2) {
      name = name.slice(-2);  // ë ë‘ ê¸€ìë§Œ ì‚¬ìš© (ì˜ˆ: ì´ì§€í›ˆ â†’ ì§€í›ˆ)
    }
    return name;
  }

  function submitVotes() {
    if (localStorage.getItem(KEY_SUBMITTED) === "yes") {
      alert("ì´ë¯¸ ì´ ê¸°ê¸°ì—ì„œ íˆ¬í‘œë¥¼ ì œì¶œí–ˆìŠµë‹ˆë‹¤!");
      return;
    }

    const clientId = getClientId();
    const submission = {}; // ì´ë²ˆì— ì œì¶œí•˜ëŠ” í•œ ì‚¬ëŒì˜ ë°ì´í„°

    QUESTIONS.forEach((_, qi) => {
      const rawFirst = document.getElementById(`q${qi}_1`).value;
      const rawSecond = document.getElementById(`q${qi}_2`).value;

      let first = normalizeName(rawFirst);
      let second = normalizeName(rawSecond);

      if (!submission[qi]) submission[qi] = {};

      // ê°™ì€ ì‚¬ëŒì„ 1ìœ„/2ìœ„ë¡œ ì“°ë©´ 1ìœ„ë§Œ ì¸ì •
      if (first && second && first === second) {
        second = "";
      }

      if (first) {
        if (!submission[qi][first]) submission[qi][first] = 0;
        submission[qi][first] += 2;
      }
      if (second) {
        if (!submission[qi][second]) submission[qi][second] = 0;
        submission[qi][second] += 1;
      }
    });

    // Firebaseì— ì €ì¥: submissions/{clientId} ì•„ë˜ì— í•œ ì‚¬ëŒ ë¶„ëŸ‰ì„ í†µì§¸ë¡œ ì €ì¥
    db.ref("submissions/" + clientId).set(submission)
      .then(() => {
        localStorage.setItem(KEY_SUBMITTED, "yes");
        alert("ì œì¶œì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ê°ì‚¬í•©ë‹ˆë‹¤ :)");
        backToMode();
      })
      .catch((err) => {
        console.error(err);
        alert("ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
      });
  }

  // ===========================
  //  ê´€ë¦¬ì ëª¨ë“œ
  // ===========================
  function showAdminLogin() {
    hideAll();
    document.getElementById("adminLogin").classList.remove("hidden");
  }

  function checkAdmin() {
    const pw = document.getElementById("adminPW").value;
    if (pw === PASSWORD) {
      showAdmin();
    } else {
      alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
    }
  }

  function showAdmin() {
    hideAll();
    document.getElementById("adminPanel").classList.remove("hidden");
    buildGraphSelector();
    refreshData();
    document.getElementById("resultBox").innerText = "ê²°ê³¼ê°€ ì—¬ê¸° í‘œì‹œë©ë‹ˆë‹¤.";
  }

  // Firebaseì—ì„œ ì „ì²´ ì œì¶œ ë°ì´í„° ì½ì–´ì˜¤ê¸°
  function refreshData() {
    db.ref("submissions").once("value").then((snapshot) => {
      cachedSubmissions = snapshot.val() || {};
      const count = Object.keys(cachedSubmissions).length;
      document.getElementById("totalVotes").innerText = count;
    });
  }

  function buildGraphSelector() {
    const sel = document.getElementById("graphSelect");
    sel.innerHTML = "";
    QUESTIONS.forEach((q, i) => {
      const opt = document.createElement("option");
      opt.value = i;
      opt.textContent = `${i + 1}. ${q}`;
      sel.appendChild(opt);
    });
  }

  // ì§ˆë¬¸ í•˜ë‚˜ì— ëŒ€í•œ í†µê³„ ê³„ì‚°
  function computeQuestionStats(questionIndex) {
    const stats = {};
    Object.values(cachedSubmissions).forEach(sub => {
      const qData = sub[questionIndex];
      if (!qData) return;
      Object.entries(qData).forEach(([name, score]) => {
        const norm = normalizeName(name);
        if (!stats[norm]) stats[norm] = 0;
        stats[norm] += score;
      });
    });
    return stats;
  }

  // ì „ì²´ í•©ì‚° í†µê³„ ê³„ì‚°
  function computeTotalStats() {
    const total = {};
    Object.values(cachedSubmissions).forEach(sub => {
      Object.values(sub).forEach(qData => {
        Object.entries(qData).forEach(([name, score]) => {
          const norm = normalizeName(name);
          if (!total[norm]) total[norm] = 0;
          total[norm] += score;
        });
      });
    });
    return total;
  }

  function showQuestionResult() {
    const idx = Number(document.getElementById("graphSelect").value);
    const stats = computeQuestionStats(idx);
    const box = document.getElementById("resultBox");

    if (!Object.keys(stats).length) {
      box.innerText = `ğŸ“Œ ${idx + 1}. ${QUESTIONS[idx]}\n\nì•„ì§ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.`;
      return;
    }

    const entries = Object.entries(stats).sort((a, b) => b[1] - a[1]);
    let text = `ğŸ“Œ ${idx + 1}. ${QUESTIONS[idx]}\n\n`;
    entries.forEach(([name, score], i) => {
      text += `${i + 1}ìœ„. ${name} : ${score}ì \n`;
    });
    box.innerText = text;
  }

  function showTotal() {
    const total = computeTotalStats();
    const box = document.getElementById("resultBox");

    if (!Object.keys(total).length) {
      box.innerText = "ğŸ“Œ ì „ì²´ í•©ì‚° ê²°ê³¼\n\nì•„ì§ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.";
      return;
    }

    const entries = Object.entries(total).sort((a, b) => b[1] - a[1]);
    let text = "ğŸ“Œ ì „ì²´ í•©ì‚° ê²°ê³¼\n\n";
    entries.forEach(([name, score], i) => {
      text += `${i + 1}ìœ„. ${name} : ${score}ì \n`;
    });
    box.innerText = text;
  }

  function resetAll() {
    if (!confirm("ì •ë§ë¡œ ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”? (ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤)")) return;

    // Firebase ë°ì´í„° ì „ì²´ ì‚­ì œ
    db.ref("submissions").set(null).then(() => {
      // ì´ ê¸°ê¸°ì˜ ì œì¶œ ê¸°ë¡ë„ ì´ˆê¸°í™”
      localStorage.removeItem(KEY_CLIENT);
      localStorage.removeItem(KEY_SUBMITTED);
      cachedSubmissions = {};
      document.getElementById("totalVotes").innerText = "0";
      document.getElementById("resultBox").innerText = "ê²°ê³¼ê°€ ì—¬ê¸° í‘œì‹œë©ë‹ˆë‹¤.";
      alert("ë°ì´í„°ë¥¼ ëª¨ë‘ ì´ˆê¸°í™”í–ˆìŠµë‹ˆë‹¤.");
    });
  }
</script>

</body>
</html>

