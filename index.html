<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì¶”ì–µì˜ ìƒì</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * { box-sizing: border-box; font-family: system-ui, sans-serif; }
    body { background:#f5f7fb; margin:0; padding:20px; }
    .container { max-width: 900px; margin:auto; }

    h1 { text-align:center; margin-bottom: 10px; }
    h2, h3 { margin-top: 0; }

    .btn {
      padding:10px 18px; border:none; border-radius:30px; cursor:pointer;
      font-weight:600; font-size:14px; color:white; background:#4b6bff;
      margin:4px; box-shadow:0 3px 8px rgba(75,107,255,0.35);
    }
    .btn.secondary { background:#e2e6ff; color:#1c266b; box-shadow:none; }
    .btn.danger { background:#ff4b6b; }

    .card {
      background:white; padding:20px; border-radius:14px;
      margin-bottom:20px; box-shadow:0 5px 16px rgba(0,0,0,0.08);
    }

    .hidden { display:none; }

    input, select {
      padding:7px 10px; border:1px solid #cfd4df; border-radius:8px; width:100%;
      font-size:14px;
    }

    .question-box { margin-bottom:14px; }
    .question-box label { font-weight:600; display:block; margin-bottom:6px; }

    .rank-label { font-size:13px; margin-top:4px; margin-bottom:2px; display:block; }

    #resultBox {
      white-space:pre-wrap;
      background:#0f172a;
      color:#e5e7eb;
      padding:12px;
      border-radius:10px;
      font-size:13px;
      max-height:400px;
      overflow-y:auto;
    }
  </style>
</head>

<body>
<div class="container">
  <h1>ì¶”ì–µì˜ ìƒì</h1>

  <!-- ëª¨ë“œ ì„ íƒ -->
  <div id="modeSelect" class="card" style="text-align:center;">
    <p>ëª¨ë“œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
    <button class="btn" onclick="showParticipant()">ì°¸ì—¬ì ëª¨ë“œ</button>
    <button class="btn secondary" onclick="showAdminLogin()">ê´€ë¦¬ì ëª¨ë“œ</button>
  </div>

  <!-- ê´€ë¦¬ì ë¡œê·¸ì¸ -->
  <div id="adminLogin" class="card hidden">
    <h3>ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ì…ë ¥</h3>
    <input type="password" id="adminPW" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
    <button class="btn" onclick="checkAdmin()">í™•ì¸</button>
    <button class="btn secondary" onclick="backToMode()">ë’¤ë¡œê°€ê¸°</button>
  </div>

  <!-- ì°¸ì—¬ì í™”ë©´ -->
  <div id="participant" class="card hidden">
    <h2>ì¹œêµ¬ë“¤ì„ ë– ì˜¬ë¦¬ë©° ì„ íƒí•´ì£¼ì„¸ìš” (TOP2)</h2>
    <p style="font-size:13px; color:#4b5563;">
      1ìœ„ëŠ” 2ì , 2ìœ„ëŠ” 1ì ìœ¼ë¡œ ë°˜ì˜ë©ë‹ˆë‹¤.<br>
      ì´ë¦„ì€ ê°€ëŠ¥í•œ í•œ ë™ì¼í•œ ë°©ì‹ìœ¼ë¡œ ì ì–´ ì£¼ì„¸ìš”. (ì˜ˆ: "ì´ì§€í›ˆ" ë˜ëŠ” "ì§€í›ˆ" ì¤‘ í•˜ë‚˜ë¡œ í†µì¼)
    </p>

    <div id="questions"></div>

    <button class="btn" onclick="submitVotes()">ì œì¶œí•˜ê¸°</button>
    <button class="btn secondary" onclick="backToMode()">ì²˜ìŒìœ¼ë¡œ</button>
  </div>

  <!-- ê´€ë¦¬ì íŒ¨ë„ -->
  <div id="adminPanel" class="card hidden">
    <h2>ê´€ë¦¬ì íŒ¨ë„</h2>
    <p style="font-size:14px;">
      <b>ì´ ì œì¶œ ì¸ì›:</b> <span id="totalVotes">0</span> ëª…
    </p>
    <div style="margin-bottom:10px;">
      <button class="btn secondary" onclick="showAdmin()">ìƒˆë¡œê³ ì¹¨</button>
      <button class="btn danger" onclick="resetAll()">ë°ì´í„° ì´ˆê¸°í™”</button>
      <button class="btn" onclick="backToMode()">ì²˜ìŒìœ¼ë¡œ</button>
    </div>

    <div class="card" style="margin:-10px -20px 10px -20px; box-shadow:none;">
      <h3>ì§ˆë¬¸ë³„ ê²°ê³¼ ë³´ê¸°</h3>
      <select id="graphSelect" style="margin-bottom:8px;"></select>
      <button class="btn secondary" onclick="showQuestionResult()">ì„ íƒí•œ ì§ˆë¬¸ ê²°ê³¼ ë³´ê¸°</button>
    </div>

    <div class="card" style="margin:-10px -20px 10px -20px; box-shadow:none;">
      <h3>ì „ì²´ í•©ì‚° ê²°ê³¼</h3>
      <button class="btn secondary" onclick="showTotal()">ì „ì²´ í•©ì‚° ì ìˆ˜ ë³´ê¸°</button>
    </div>

    <h3>ê²°ê³¼ ì¶œë ¥</h3>
    <div id="resultBox">ê²°ê³¼ê°€ ì—¬ê¸° í‘œì‹œë©ë‹ˆë‹¤.</div>
  </div>
</div>

<script>
  // ===========================
  //  ì„¤ì • & ìƒìˆ˜
  // ===========================
  const QUESTIONS = [
    "ì²­ì†Œë¥¼ ì—´ì‹¬íˆ í•˜ë˜ ì¹œêµ¬",
    "ë„ì›€ì´ í•„ìš”í•  ë•Œ ê¸°ëŒˆ ìˆ˜ ìˆì—ˆë˜ ì¹œêµ¬",
    "í•™êµ í–‰ì‚¬, ì¼ì • ë“± ì „ë‹¬ ì‚¬í•­ì„ ì˜ ê³µì§€í•´ì£¼ë˜ ì¹œêµ¬",
    "ìˆ˜ì—… ë¶„ìœ„ê¸° ì¡°ì„±ì„ ì˜ ë§ì¶°ì£¼ë˜ ì¹œêµ¬",
    "í˜ë“¤ ë•Œ ì›ƒì„ ìˆ˜ ìˆê²Œ í•´ì£¼ë˜ ì¹œêµ¬",
    "í•™êµ í–‰ì‚¬ì— ì—´ì‹¬íˆ ì°¸ì—¬í•˜ë˜ ì¹œêµ¬",
    "ë¦¬ë”ì‹­, ì¹´ë¦¬ìŠ¤ë§ˆê°€ ë„˜ì¹˜ë˜ ì¹œêµ¬",
    "ë´‰ì‚¬í™œë™ì„ ì—´ì‹¬íˆ í•˜ë˜ ì¹œêµ¬",
    "ì‚¬ì†Œí•œ ì¼ì—ë„ ì•½ì†ì„ ì˜ ì§€í‚¤ë˜ ì¹œêµ¬",
    "ë°”ë¥¸ì–¸ì–´, ë°”ë¥¸ í–‰ë™ ë“± í’ˆì„±ì´ ì•„ë¦„ë‹µë˜ ì¹œêµ¬"
  ];

  const PASSWORD = "YCHS1315";

  // localStorage í‚¤ (ë²„ì „ ì˜¬ë ¤ì„œ ì´ì „ ë°ì´í„°ì™€ êµ¬ë¶„)
  const KEY_DATA = "memoryBox_voteData_v2";
  const KEY_SUBMITTED = "memoryBox_submitted_v2";
  const KEY_COUNT = "memoryBox_voteCount_v2";

  // ===========================
  //  ê³µí†µ UI ì œì–´
  // ===========================
  function hideAll() {
    document.getElementById("modeSelect").classList.add("hidden");
    document.getElementById("adminLogin").classList.add("hidden");
    document.getElementById("participant").classList.add("hidden");
    document.getElementById("adminPanel").classList.add("hidden");
  }

  function backToMode() {
    hideAll();
    document.getElementById("modeSelect").classList.remove("hidden");
  }

  // ===========================
  //  ì°¸ì—¬ì ëª¨ë“œ
  // ===========================
  function showParticipant() {
    if (localStorage.getItem(KEY_SUBMITTED) === "yes") {
      alert("ì´ë¯¸ ì´ ê¸°ê¸°ì—ì„œ íˆ¬í‘œë¥¼ ì œì¶œí–ˆìŠµë‹ˆë‹¤!");
      return;
    }
    hideAll();
    document.getElementById("participant").classList.remove("hidden");
    buildQuestionForm();
  }

  function buildQuestionForm() {
    const box = document.getElementById("questions");
    box.innerHTML = "";

    QUESTIONS.forEach((q, i) => {
      box.innerHTML += `
        <div class="question-box">
          <label>${i + 1}. ${q}</label>
          <span class="rank-label">1ìœ„ (2ì )</span>
          <input id="q${i}_1" placeholder="ì˜ˆ: ì´ì§€í›ˆ / ì§€í›ˆ">
          <span class="rank-label">2ìœ„ (1ì )</span>
          <input id="q${i}_2" placeholder="ì˜ˆ: ì´ì§€í›ˆ / ì§€í›ˆ">
        </div>
      `;
    });
  }

  // ì´ë¦„ ì •ê·œí™” í•¨ìˆ˜
  function normalizeName(name, existingNames) {
    if (!name) return "";

    // 1) ì•ë’¤ ê³µë°± ì œê±°
    name = name.trim();

    // 2) ëª¨ë“  ê³µë°± ì œê±°
    name = name.replace(/\s+/g, "");

    // 3) ë í˜¸ì¹­ ì œê±° (ì´, ì•¼, ë‹˜, êµ°, ì–‘, ì”¨, ìš”)
    name = name.replace(/(ì´|ì•¼|ë‹˜|êµ°|ì–‘|ì”¨|ìš”)$/g, "");

    // 4) ê¸°ì¡´ ì´ë¦„ ëª©ë¡ê³¼ í¬í•¨ ê´€ê³„ ë¹„êµ
    for (let saved of existingNames) {
      if (!saved) continue;
      if (saved.includes(name) || name.includes(saved)) {
        return saved; // ê¸°ì¡´ ì´ë¦„ìœ¼ë¡œ í†µì¼
      }
    }

    return name;
  }

  function submitVotes() {
    if (localStorage.getItem(KEY_SUBMITTED) === "yes") {
      alert("ì´ë¯¸ ì´ ê¸°ê¸°ì—ì„œ íˆ¬í‘œë¥¼ ì œì¶œí–ˆìŠµë‹ˆë‹¤!");
      return;
    }

    // ê¸°ì¡´ ë°ì´í„° ë¡œë“œ
    const rawData = localStorage.getItem(KEY_DATA);
    let data = rawData ? JSON.parse(rawData) : {};

    // ê¸°ì¡´ì— ì €ì¥ëœ ëª¨ë“  ì´ë¦„ ëª©ë¡ ìˆ˜ì§‘
    const existingNameSet = new Set();
    Object.values(data).forEach(qObj => {
      Object.keys(qObj).forEach(n => existingNameSet.add(n));
    });

    // ì œì¶œí•œ ë‚´ìš© ë°˜ì˜
    QUESTIONS.forEach((_, qi) => {
      if (!data[qi]) data[qi] = {};

      // í˜„ì¬ ì§ˆë¬¸ì—ì„œ ì…ë ¥í•œ ì´ë¦„
      let rawFirst = document.getElementById(`q${qi}_1`).value;
      let rawSecond = document.getElementById(`q${qi}_2`).value;

      // ì •ê·œí™”
      let first = normalizeName(rawFirst, existingNameSet);
      if (first) existingNameSet.add(first); // ìƒˆë¡œ ë“±ì¥í•˜ë©´ ëª©ë¡ì— ì¶”ê°€

      let second = normalizeName(rawSecond, existingNameSet);
      if (second) existingNameSet.add(second);

      // ê°™ì€ ì‚¬ëŒì„ 1ìœ„/2ìœ„ë¡œ ì¤‘ë³µ ì ìœ¼ë©´ 1ìœ„ë§Œ ì¸ì •
      if (first && second && first === second) {
        // 2ìœ„ëŠ” ë¬´ì‹œ
        second = "";
      }

      // ì ìˆ˜ ë°˜ì˜
      if (first) {
        if (!data[qi][first]) data[qi][first] = 0;
        data[qi][first] += 2; // 1ìœ„ 2ì 
      }
      if (second) {
        if (!data[qi][second]) data[qi][second] = 0;
        data[qi][second] += 1; // 2ìœ„ 1ì 
      }
    });

    // ì €ì¥
    localStorage.setItem(KEY_DATA, JSON.stringify(data));

    // ì œì¶œ ì¸ì› +1
    let count = Number(localStorage.getItem(KEY_COUNT) || "0");
    localStorage.setItem(KEY_COUNT, count + 1);

    // ì¤‘ë³µ ì œì¶œ ë°©ì§€ í”Œë˜ê·¸
    localStorage.setItem(KEY_SUBMITTED, "yes");

    alert("ì œì¶œì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ê°ì‚¬í•©ë‹ˆë‹¤ :)");
    backToMode();
  }

  // ===========================
  //  ê´€ë¦¬ì ëª¨ë“œ
  // ===========================
  function showAdminLogin() {
    hideAll();
    document.getElementById("adminLogin").classList.remove("hidden");
  }

  function checkAdmin() {
    const pw = document.getElementById("adminPW").value;
    if (pw === PASSWORD) {
      showAdmin();
    } else {
      alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
    }
  }

  function showAdmin() {
    hideAll();
    document.getElementById("adminPanel").classList.remove("hidden");
    updateTotalVotes();
    buildGraphSelector();
    document.getElementById("resultBox").innerText = "ê²°ê³¼ê°€ ì—¬ê¸° í‘œì‹œë©ë‹ˆë‹¤.";
  }

  function updateTotalVotes() {
    const count = Number(localStorage.getItem(KEY_COUNT) || "0");
    document.getElementById("totalVotes").innerText = count;
  }

  function buildGraphSelector() {
    const sel = document.getElementById("graphSelect");
    sel.innerHTML = "";
    QUESTIONS.forEach((q, i) => {
      const opt = document.createElement("option");
      opt.value = i;
      opt.textContent = `${i + 1}. ${q}`;
      sel.appendChild(opt);
    });
  }

  function loadData() {
    const raw = localStorage.getItem(KEY_DATA);
    return raw ? JSON.parse(raw) : {};
  }

  function showQuestionResult() {
    const idx = Number(document.getElementById("graphSelect").value);
    const data = loadData();
    const qData = data[idx];

    const box = document.getElementById("resultBox");

    if (!qData || Object.keys(qData).length === 0) {
      box.innerText = `ğŸ“Œ ${idx + 1}. ${QUESTIONS[idx]}\n\nì•„ì§ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.`;
      return;
    }

    const entries = Object.entries(qData).sort((a, b) => b[1] - a[1]);
    let text = `ğŸ“Œ ${idx + 1}. ${QUESTIONS[idx]}\n\n`;

    entries.forEach(([name, score], i) => {
      text += `${i + 1}ìœ„. ${name} : ${score}ì \n`;
    });

    box.innerText = text;
  }

  function showTotal() {
    const data = loadData();
    const total = {};

    // ëª¨ë“  ì§ˆë¬¸ì˜ ì ìˆ˜ í•©ì‚°
    Object.values(data).forEach(qObj => {
      Object.entries(qObj).forEach(([name, score]) => {
        if (!total[name]) total[name] = 0;
        total[name] += score;
      });
    });

    const box = document.getElementById("resultBox");

    if (Object.keys(total).length === 0) {
      box.innerText = "ğŸ“Œ ì „ì²´ í•©ì‚° ê²°ê³¼\n\nì•„ì§ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.";
      return;
    }

    const entries = Object.entries(total).sort((a, b) => b[1] - a[1]);
    let text = "ğŸ“Œ ì „ì²´ í•©ì‚° ê²°ê³¼\n\n";

    entries.forEach(([name, score], i) => {
      text += `${i + 1}ìœ„. ${name} : ${score}ì \n`;
    });

    box.innerText = text;
  }

  function resetAll() {
    if (!confirm("ì •ë§ë¡œ ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”? (ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤)")) return;

    localStorage.removeItem(KEY_DATA);
    localStorage.removeItem(KEY_SUBMITTED);
    localStorage.removeItem(KEY_COUNT);

    alert("ë°ì´í„°ë¥¼ ëª¨ë‘ ì´ˆê¸°í™”í–ˆìŠµë‹ˆë‹¤.");
    showAdmin();
  }
</script>
</body>
</html>
